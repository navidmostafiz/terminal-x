<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>terminal-x</title>
    <!-- <link rel="icon" type="image/x-icon" href="favicon.ico"> -->

    <style>
        body {
            background-color: black;
            margin: 0;
            padding: 0;
            display: inline;
        }

        .tunC,
        .ttokC,
        .toutC,
        .tinC {
            background-color: black;
            font-size: 12pt;
            color: darkred;
            width: 100%;
            margin: 0;
            padding: 0;
            border: none;
            border-width: 0;
            box-shadow: none;
            display: unset;
            -webkit-appearance: unset;
        }

        /* pseudo elements */
        :focus {
            outline: -webkit-focus-ring-color auto 0px;
        }
    </style>

</head>

<body>
    <!-- ALL HTML GOES HERE -->
    <input id="tunID" class="tunC" type="text" name="tunN" placeholder="enter username">
    <input id="ttokID" class="ttokC" type="password" name="ttokN" placeholder="enter secret token">
    <!-- <textarea id="toutID" class="toutC" name="toutN" row=0 readonly
        placeholder="admin: terminal-x is loading..."></textarea> -->

    <div id="toutID" class="toutC" name="toutN">
        admin: welcome to terminal-x

    </div>

    <input id="tinID" class="tinC" type="text" name="tinN" placeholder=" says">
    <!-- ALL HTML GOES HERE -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        //SOCKET CONNECTION CHATROOM
        var socket1 = io.connect();
        var tun = document.getElementById("tunID");
        var ttok = document.getElementById("ttokID");
        var tout = document.getElementById("toutID");
        var tin = document.getElementById("tinID");
        var userName = "";
        var ttokValue = "";
        var msg = "";
        var roomName = "";
        // INITIAL
        tun.focus();
        toggleShow(ttok);
        toggleShow(tout);
        toggleShow(tin);
        //+++++++++++++++++++++++++++++++++++++
        function addLink(from, msg) {
            var breakNODE = document.createElement("BR");
            var anchoreNODE = document.createElement('a');
            anchoreNODE.setAttribute('href', msg);
            anchoreNODE.setAttribute('target', '_blank');
            var textnode = document.createTextNode(decryptedMSG(msg));
            anchoreNODE.appendChild(textnode);
            tout.appendChild(breakNODE);
            tout.appendChild(anchoreNODE);
        }
        //+++++++++++++++++++++++++++++++++++++
        function youtube_parser(url) {
            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            var match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : false;
        }

        function addYoutubeLink(from, msg) {
            var paraNODE = document.createElement("P");
            paraNODE.style.margin = 0;
            var textnode = document.createTextNode(from + ": " + decryptedMSG(msg));
            paraNODE.appendChild(textnode);
            //++++++++++++++++++++++++
            var youtubeVideoID = youtube_parser(msg);
            var youtubeImageLink = "https://img.youtube.com/vi/" + youtubeVideoID + "/0.jpg";
            var anchoreNODE = document.createElement('a');
            anchoreNODE.setAttribute('href', msg);
            anchoreNODE.setAttribute('target', '_blank');
            var imageNode = document.createElement("IMG");
            imageNode.setAttribute('src', youtubeImageLink);
            imageNode.setAttribute('height', 100);
            anchoreNODE.appendChild(imageNode);
            //++++++++++++++++++++++++
            tout.appendChild(paraNODE);
            tout.appendChild(anchoreNODE);
        }
        //+++++++++++++++++++++++++++++++++++++
        function addText(from, msg) {
            var paraNODE = document.createElement("P");
            paraNODE.style.margin = 0;
            var textnode = document.createTextNode(from + ": " + decryptedMSG(msg));
            paraNODE.appendChild(textnode);
            tout.appendChild(paraNODE);
        }
        //+++++++++++++++++++++++++++++++++++++
        function getDataType(msg) {
            if (msg.includes("youtube")) {
                return "youtubeLink";
            } else if (msg.includes(".com") || msg.includes(".net") || msg.includes(".org")) {
                return "link";
            }
            else {
                return "text";
            }
        }
        //+++++++++++++++++++++++++++++++++++++
        // LISTENER TO SERVER:
        //+++++++++++++++++++++++++++++++++++++
        socket1.on('message_to_client', function ({ from, msg }) {
            console.log("LOG: [EVENT=message_to_client] [roomName=" + roomName + "] [from=" + from + "] [msg=" + msg + "]");
            // ******
            // tout.innerHTML += "</br>" + decryptedMSG(data);
            // tout.rows += 1;
            // ******

            var dataType = getDataType(msg);

            switch (dataType) {
                case "youtubeLink":
                    addYoutubeLink(from, msg);
                    break;
                case "link":
                    addLink(from, msg);
                    break;
                case "text":
                    addText(from, msg);
                    break;
                default:
                    addText(from, msg)
            }


        });
        //+++++++++++++++++++++++++++++++++++++
        // SEND TO SERVER:
        //+++++++++++++++++++++++++++++++++++++
        function sendToServer(msg, roomName) {
            console.log("LOG: [EVENT=message_to_server] [roomName=" + roomName + "] [from=" + userName + "] [msg=" + msg + "]");
            socket1.emit('message_to_server', { roomName, from: userName, msg });
        }
        //+++++++++++++++++++++++++++++++++++++
        function decryptedMSG(value) {
            return value;
        }
        //+++++++++++++++++++++++++++++++++++++
        function encryptedMSG(value) {
            return value;
        }
        //+++++++++++++++++++++++++++++++++++++
        function removeElement(xx) {
            xx.value = "";
            xx.blur();
            toggleShow(xx);
        }
        //HIDE/SHOW ELEMENTS
        function toggleShow(x) {
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }

        //USERNAME GIVEN, HIDE IT AND SHOW TOKEN INPUT
        tun.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                //+++++++++++++++++++++++++++++++++++++
                if (tun.value != "") {
                    userName = tun.value;
                    //REMOVE TUN
                    removeElement(tun);
                    //SHOW TTOK
                    toggleShow(ttok);
                    ttok.focus();
                    //mod tin
                    tin.placeholder = "say something " + userName;
                } else {
                    tun.placeholder = "admin: what was that?";
                    setTimeout(() => { tun.placeholder = "enter username"; }, 1000);
                }
                //+++++++++++++++++++++++++++++++++++++
            }
        });

        //TOKEN GIVEN, HIDE IT AND SHOW TERMINAL OUTPUT AND INPUT
        ttok.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                //+++++++++++++++++++++++++++++++++++++
                if (ttok.value != "") {
                    //SAVE TTOK VALUE
                    ttokValue = ttok.value;
                    //CREATE A ROOM IN SEVERSIDE: ROOM
                    roomName = ttokValue;
                    socket1.emit('join_room', roomName);

                    //REMOVE TTOK
                    removeElement(ttok);
                    //SHOW TERMINAL OUT AND INT
                    toggleShow(tout);
                    toggleShow(tin);
                    tin.focus();
                } else {
                    ttok.placeholder = "admin: what was that?";
                    setTimeout(() => { ttok.placeholder = "enter secret token"; }, 1000);
                }
                //+++++++++++++++++++++++++++++++++++++
            }
        });

        //USER GAVE INPUT, APPEND TO OUTPUT TERMINAL + SEND TO SERVER
        tin.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                //+++++++++++++++++++++++++++++++++++++
                if (tin.value != "") {
                    //SEND TO SERVER
                    sendToServer(tin.value, ttokValue);
                    //RESET INPUT TERMINAL
                    tin.value = ""
                } else {
                    tin.placeholder = "admin: what was that?";
                    setTimeout(() => { tin.placeholder = "say something " + userName; }, 1000);
                }
                //+++++++++++++++++++++++++++++++++++++
            }
        });
        //+++++++++++++++++++++++++++++++++++++
        function makeTINFocus() {
            tout.blur;
            tin.focus();
        }
        //+++++++++++++++++++++++++++++++++++++
        tin.onmouseout = makeTINFocus;
        tout.onmouseenter = makeTINFocus;
        tout.onclick = makeTINFocus;




    </script>
</body>

</html>